name: CI/CD (Frontend + Backend)

# Dispara en push y PR hacia main y dev
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

# Permisos mínimos para GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Evita despliegues concurrentes de Pages
concurrency:
  group: pages
  cancel-in-progress: true

env:
  # Directorios del monorepo (ajusta si cambias estructura)
  FRONTEND_DIR: frontend
  BACKEND_DIR: backend
  # Directorio de build del frontend (Vite -> dist, CRA -> build)
  FRONTEND_BUILD_DIR: dist

jobs:
  frontend:
    name: Frontend - Install, Test, Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.FRONTEND_DIR }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests (if any)
        # Ejecuta tests si existe script test; si no, continúa
        run: |
          if npm run -s | grep -q " test\b"; then
            npm test --silent --if-present || npm run test --if-present
          else
            echo "No test script found, skipping"
          fi

      - name: Build
        run: |
          if npm run -s | grep -q " build\b"; then
            npm run build
          else
            echo "No build script found. Add one to package.json" && exit 1
          fi

      - name: Upload Pages artifact (frontend)
        # Sube el artefacto sólo para despliegue en GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.FRONTEND_DIR }}/${{ env.FRONTEND_BUILD_DIR }}

  deploy_pages:
    name: Frontend - Deploy to GitHub Pages
    needs: frontend
    runs-on: ubuntu-latest
    # Despliega automáticamente sólo en pushes a main
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

  backend:
    name: Backend - Install, Test, (Optional) Deploy
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.BACKEND_DIR }}
    services:
      # Ejemplo de base de datos temporal para tests (opcional). Comenta si no usas DB en tests.
      # mysql:
      #   image: mysql:8
      #   env:
      #     MYSQL_DATABASE: app
      #     MYSQL_USER: app
      #     MYSQL_PASSWORD: password
      #     MYSQL_ROOT_PASSWORD: password
      #   ports: ['3306:3306']
      #   options: >-
      #     --health-cmd="mysqladmin ping -h 127.0.0.1 -u root -ppassword"
      #     --health-interval=10s
      #     --health-timeout=5s
      #     --health-retries=5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo, pdo_mysql, bcmath, curl, openssl
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles(format('{0}/composer.lock', env.BACKEND_DIR)) }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install PHP dependencies
        run: composer install --no-interaction --prefer-dist --no-progress --no-suggest

      - name: Prepare app env (if Laravel)
        shell: bash
        run: |
          if [ -f artisan ]; then
            if [ -f .env.example ]; then cp .env.example .env; fi
            php artisan key:generate || true
          fi

      - name: Run PHPUnit (if present)
        shell: bash
        run: |
          if [ -f vendor/bin/phpunit ]; then
            ./vendor/bin/phpunit --no-coverage
          else
            echo "PHPUnit not found, skipping"
          fi

      # Despliegue backend mediante Render Deploy Hook (simple y gratis)
      - name: Deploy backend to Render (only on main, if hook set)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && env.RENDER_DEPLOY_HOOK_URL != ''
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          echo "Triggering Render deploy via deploy hook..."
          curl -fsS -X POST "$RENDER_DEPLOY_HOOK_URL"
          echo "Render deploy triggered."

name: CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb
        ports: ['3306:3306']
        options: >-
          --health-cmd "mysqladmin ping -h 127.0.0.1 -uroot -proot"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3

    steps:
      - uses: actions/checkout@v3

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install dependencies
        run: |
          cd backend
          composer install --no-progress --prefer-dist --optimize-autoloader
          cp .env.example .env
          php artisan key:generate

      - name: Run tests
        run: |
          cd backend
          php artisan test

      - name: Build frontend
        run: |
          cd frontend
          npm install
          npm run build
